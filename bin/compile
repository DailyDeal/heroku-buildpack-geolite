#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

SCRIPT="heroku-buildpack-geolite/compile"

# fail fast
set -e

# debug
# set -x

put() {
  echo "       " "$*"
}

put "script started in__ $(pwd)"
put "script started with $*"
put ""

# clean up leaking environment
unset GIT_DIR

# config

# parse and derive params
[ -z "$1" ] && TEMP_DIR=$(mktemp -d /tmp/heroku_buldpack_geolite.XXXXXX)
BUILD_DIR=${1:-$TEMP_DIR/build}
CACHE_DIR=${2:-$TEMP_DIR/cache}
ENV_DIR=${3:-$TEMP_DIR/env}

put "started with:\
  BUILD_DIR: $BUILD_DIR,\
  CACHE_DIR: $CACHE_DIR,\
  ENV_DIR: $ENV_DIR\
"

GEOLITE_DIR=vendor/geolite
DOWNLOADER=$GEOLITE_DIR/bin/geolite_download

PROFILE=$BUILD_DIR/.profile.d/geolite.sh
mkdir -p $(dirname $PROFILE)
[ -f $PROFILE ] && put "$PROFILE profile already exist: $PROFILE" && exit 1

cat <<EOF >$PROFILE
  /app/$DOWNLOADER &
EOF
put "profile___ created: $PROFILE"

DOWNLOAD_DIR=$GEOLITE_DIR/downloads
DOWNLOADER=$BUILD_DIR/$DOWNLOADER
[ -d $BUILD_DIR/$GEOLITE_DIR ] && put "error: directory already exist: $BUILD_DIR/$GEOLITE_DIR" && exit 1
mkdir -p $BUILD_DIR/$DOWNLOAD_DIR
mkdir -p $(dirname $DOWNLOADER)

cat <<EOF >$DOWNLOADER
#!/usr/bin/env bash
# geolite_download [<home-dir>] # into -> <home-dir>/$DOWNLOAD_DIR/<day>-<time>.<pid>/

SCRIPT="\$0"

# fail fast
set -e

# debug
# set -x

put() {
  echo "\$SCRIPT:" "\$*"
}

put "script started in__ \$(pwd)"
put "script started with \$*"
put ""

HOME_DIR=\${1:-\$HOME}

if [ ! -z "\${GEOLITE_CITY_TARGET_PATH}" ]; then
  mkdir -p \$(dirname \$GEOLITE_CITY_TARGET_PATH)
  touch \$GEOLITE_CITY_TARGET_PATH
  [ -z "\${GEOLITE_CITY_SOURCE_URL}" ] && cat /dev/null >\${GEOLITE_CITY_TARGET_PATH}
fi

if [ ! -z "\${GEOLITE_CITY_SOURCE_URL}" ]; then

  DOWNLOAD_DIR=\$HOME_DIR/$DOWNLOAD_DIR/\$(date +%Y%m%d-%H%M%S).\$\$
  mkdir \$DOWNLOAD_DIR
  put "Download started  at \$(date +%H:%M:%S) from \$GEOLITE_CITY_SOURCE_URL into \$DOWNLOAD_DIR ..."

  (cd \$DOWNLOAD_DIR && curl -O \$GEOLITE_CITY_SOURCE_URL)

  put "Download finished at \$(date +%H:%M:%S), creating database ..."

  DOWNLOADED_FILE=\$(ls \$DOWNLOAD_DIR/*)
  DOWNLOADED_NAME=\$(basename \$DOWNLOADED_FILE .tar.gz)

  [ -z "\${GEOLITE_CITY_TARGET_PATH}" ] && GEOLITE_CITY_TARGET_PATH=\$HOME_DIR/$GEOLITE_DIR/\$DOWNLOADED_NAME.db
  [ ! -f \${GEOLITE_CITY_TARGET_PATH} ] || (mkdir -p \$(dirname \$GEOLITE_CITY_TARGET_PATH) && touch \$GEOLITE_CITY_TARGET_PATH)

  (cd \$DOWNLOAD_DIR && (gunzip -c \$DOWNLOADED_FILE | tar -x) && cat \$(find . -name '*.mmdb') > \$GEOLITE_CITY_TARGET_PATH)

  put "DB creating ended at \$(date +%H:%M:%S): \$GEOLITE_CITY_DB"
else
  put "nothing to do (use GEOLITE_CITY_SOURCE_URL to download data)"
fi
EOF
chmod +x $DOWNLOADER
put "downloader created: $DOWNLOADER"

echo "-----> geolite done"
